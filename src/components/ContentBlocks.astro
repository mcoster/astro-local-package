---
import { marked } from 'marked';
import { getAltText } from '@/lib/image-alt-generator';

export interface ContentBlock {
  heading?: string;
  content: string;
  image?: string;
  imageAlt?: string;
  imagePosition?: 'left' | 'right';
  background?: 'white' | 'gray' | 'primary' | 'gradient';
  variant?: 'default' | 'compact' | 'expanded';
  cta?: {
    text: string;
    href: string;
  };
}

export interface Props {
  blocks: ContentBlock[];
  alternateBackground?: boolean;
  defaultBackground?: 'white' | 'gray';
}

const { 
  blocks, 
  alternateBackground = true,
  defaultBackground = 'white'
} = Astro.props;

// Process blocks with alternating backgrounds if enabled
const processedBlocks = blocks.map((block, index) => {
  if (!block.background && alternateBackground) {
    const backgrounds = ['white', 'gray'];
    const startIndex = defaultBackground === 'gray' ? 1 : 0;
    block.background = backgrounds[(startIndex + index) % 2] as 'white' | 'gray';
  }
  return block;
});
---

<div class="content-blocks">
  {processedBlocks.map((block, index) => {
    // Convert markdown content to HTML
    const htmlContent = marked.parse(block.content || '');
    
    // Determine image position (alternate if not specified)
    const imagePosition = block.imagePosition || (index % 2 === 0 ? 'right' : 'left');
    
    return (
      <section 
        class={`content-block content-block--bg-${block.background || 'white'} content-block--${block.variant || 'default'}`}
        data-position={imagePosition}
      >
        <div class="content-block__container">
          <div class={`content-block__grid content-block__grid--${imagePosition}`}>
            <div class="content-block__content">
              {block.heading && (
                <h2 class="content-block__heading">{block.heading}</h2>
              )}
              <div class="content-block__text" set:html={htmlContent} />
              {block.cta && (
                <a href={block.cta.href} class="content-block__cta">
                  {block.cta.text}
                </a>
              )}
            </div>
            {block.image && (
              <div class="content-block__image-wrapper">
                <img 
                  src={block.image} 
                  alt={getAltText(block.imageAlt, block.image, 'Content image')}
                  class="content-block__image"
                  loading="lazy"
                />
              </div>
            )}
          </div>
        </div>
      </section>
    );
  })}
</div>

<style>
  .content-blocks {
    /* Container for multiple content blocks */
  }

  .content-block {
    padding: 4rem 0;
    background: white;
  }
  
  /* Background variants */
  .content-block--bg-white {
    background: white;
  }
  
  .content-block--bg-gray {
    background: #f9fafb;
  }
  
  .content-block--bg-primary {
    background: var(--color-primary-light, #eff6ff);
  }
  
  .content-block--bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  
  .content-block--bg-gradient .content-block__heading,
  .content-block--bg-gradient .content-block__text,
  .content-block--bg-gradient .content-block__text strong {
    color: white;
  }
  
  /* Size variants */
  .content-block--compact {
    padding: 2rem 0;
  }
  
  .content-block--expanded {
    padding: 6rem 0;
  }

  .content-block__container {
    max-width: 80rem;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .content-block__grid {
    display: grid;
    gap: 3rem;
    align-items: center;
  }

  @media (min-width: 768px) {
    .content-block__grid {
      grid-template-columns: 1fr 1fr;
      gap: 4rem;
    }

    .content-block__grid--left .content-block__image-wrapper {
      order: -1;
    }
  }

  .content-block__heading {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 1.5rem;
    color: var(--color-primary, #1f2937);
    line-height: 1.2;
  }

  @media (min-width: 768px) {
    .content-block__heading {
      font-size: 2.5rem;
    }
  }

  .content-block__text {
    font-size: 1.125rem;
    line-height: 1.75;
    color: #4b5563;
  }
  
  /* Style markdown content */
  .content-block__text h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 1.5rem 0 1rem;
    color: var(--color-primary, #1f2937);
  }
  
  .content-block__text p {
    margin-bottom: 1rem;
  }
  
  .content-block__text ul,
  .content-block__text ol {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }
  
  .content-block__text li {
    margin-bottom: 0.5rem;
  }
  
  .content-block__text strong {
    font-weight: 600;
    color: #1f2937;
  }
  
  .content-block__text blockquote {
    border-left: 4px solid var(--color-primary, #3b82f6);
    padding-left: 1rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #6b7280;
  }
  
  .content-block__text code {
    background: #f3f4f6;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }
  
  .content-block__text table {
    width: 100%;
    margin: 1.5rem 0;
    border-collapse: collapse;
  }
  
  .content-block__text th,
  .content-block__text td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .content-block__text th {
    font-weight: 600;
    background: #f9fafb;
  }

  .content-block__cta {
    display: inline-block;
    margin-top: 1.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--color-primary, #3b82f6);
    color: white;
    font-weight: 500;
    text-decoration: none;
    border-radius: 0.375rem;
    transition: background 150ms ease;
  }
  
  .content-block__cta:hover {
    background: var(--color-primary-dark, #2563eb);
  }
  
  .content-block--bg-gradient .content-block__cta {
    background: white;
    color: var(--color-primary, #3b82f6);
  }
  
  .content-block--bg-gradient .content-block__cta:hover {
    background: #f3f4f6;
  }

  .content-block__image-wrapper {
    position: relative;
    overflow: hidden;
    border-radius: 0.5rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }

  .content-block__image {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 300ms ease;
  }

  .content-block__image-wrapper:hover .content-block__image {
    transform: scale(1.05);
  }

  /* Mobile: Always show text first */
  @media (max-width: 767px) {
    .content-block__image-wrapper {
      order: 2;
    }
    
    .content-block__content {
      order: 1;
    }
  }
</style>