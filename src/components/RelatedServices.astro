---
import { getCollection } from 'astro:content';
import Section from './Section.astro';
import ServiceCard from './ServiceCard.astro';

export interface Props {
  heading?: string;
  subtitle?: string;
  currentService?: string;
  excludeSlug?: string;
  limit?: number;
  showAll?: boolean;
  variant?: 'white' | 'gray' | 'primary' | 'gradient' | 'transparent';
  className?: string;
  maxCardWidth?: number;
}

const {
  heading = 'Other Services We Offer',
  subtitle,
  currentService,
  excludeSlug,
  limit = 3,
  showAll = false,
  variant = 'gray',
  className = '',
  maxCardWidth = 400
} = Astro.props;

// Support both prop names for excluding the current service
const excludeKey = excludeSlug || currentService;

// Get all services
const allServices = await getCollection('services');

// Filter out current service and sort by order
const relatedServices = allServices
  .filter(service => service.slug !== excludeKey)
  .sort((a, b) => (a.data.order || 99) - (b.data.order || 99))
  .slice(0, showAll ? undefined : (limit || undefined));

// Map to ServiceCard-compatible format
const services = relatedServices.map(service => ({
  title: service.data.title,
  description: service.data.excerpt,
  icon: service.data.icon,
  image: service.data.image,
  href: `/services/${service.slug}`,
}));

// Determine optimal columns based on service count (same logic as ServicesGrid)
const serviceCount = services.length;
let desktopCols: number;
let splitAt = 0;

if (serviceCount <= 3) {
  desktopCols = serviceCount || 1;
} else if (serviceCount === 4) {
  desktopCols = 2;
} else if (serviceCount % 3 === 1 && serviceCount >= 7) {
  desktopCols = 3;
  splitAt = serviceCount - 4;
} else {
  desktopCols = 3;
}
---

<Section variant={variant} className={`related-services ${className}`}>
  <div class="rs-container">
    {(heading || subtitle) && (
      <div class="rs-header">
        {heading && (
          <h2 class="text-3xl md:text-4xl font-bold mb-4 text-gray-900">{heading}</h2>
        )}
        {subtitle && (
          <p class="rs-subtitle">{subtitle}</p>
        )}
      </div>
    )}

    <div class="rs-grid-wrapper">
      {splitAt > 0 ? (
        <>
          <div
            class="rs-grid rs-grid--desktop-3"
            style={`--max-card-width: ${maxCardWidth}px;`}
          >
            {services.slice(0, splitAt).map((service) => (
              <ServiceCard
                title={service.title}
                description={service.description}
                icon={service.icon}
                image={service.image}
                href={service.href}
              />
            ))}
          </div>
          <div
            class="rs-grid rs-grid--desktop-2"
            style={`--max-card-width: ${maxCardWidth}px;`}
          >
            {services.slice(splitAt).map((service) => (
              <ServiceCard
                title={service.title}
                description={service.description}
                icon={service.icon}
                image={service.image}
                href={service.href}
              />
            ))}
          </div>
        </>
      ) : (
        <div
          class={`rs-grid rs-grid--desktop-${desktopCols}`}
          style={`--max-card-width: ${maxCardWidth}px;`}
        >
          {services.map((service) => (
            <ServiceCard
              title={service.title}
              description={service.description}
              icon={service.icon}
              image={service.image}
              href={service.href}
            />
          ))}
        </div>
      )}
    </div>

    {!showAll && allServices.length > limit + 1 && (
      <div class="rs-footer">
        <a
          href="/#services"
          class="inline-flex items-center text-blue-600 hover:text-blue-800 font-semibold"
        >
          View All Services
          <svg
            class="w-4 h-4 ml-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </a>
      </div>
    )}
  </div>
</Section>

<style>
  .rs-container {
    max-width: 80rem;
    margin-left: auto;
    margin-right: auto;
    padding-left: 1rem;
    padding-right: 1rem;
  }

  @media (min-width: 640px) {
    .rs-container {
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .rs-container {
      padding-left: 2rem;
      padding-right: 2rem;
    }
  }

  .rs-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .rs-subtitle {
    font-size: 1.125rem;
    line-height: 1.75rem;
    color: rgb(75 85 99);
    max-width: 42rem;
    margin-left: auto;
    margin-right: auto;
  }

  /* Wrapper ensures consistent gap between split grids */
  .rs-grid-wrapper {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    align-items: center;
  }

  .rs-grid {
    display: grid;
    gap: 1.5rem;
    justify-content: center;
    width: 100%;
  }

  /* Mobile: single column, full width */
  @media (max-width: 639px) {
    .rs-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
  }

  /* Tablet: max 2 columns */
  @media (min-width: 640px) and (max-width: 1023px) {
    .rs-grid {
      grid-template-columns: repeat(2, minmax(0, var(--max-card-width, 400px)));
    }
    .rs-grid--desktop-1 {
      grid-template-columns: minmax(0, var(--max-card-width, 400px));
    }
  }

  /* Desktop: column count based on service count */
  @media (min-width: 1024px) {
    .rs-grid--desktop-1 {
      grid-template-columns: var(--max-card-width, 400px);
    }
    .rs-grid--desktop-2 {
      grid-template-columns: repeat(2, var(--max-card-width, 400px));
    }
    .rs-grid--desktop-3 {
      grid-template-columns: repeat(3, var(--max-card-width, 400px));
    }
  }

  .rs-footer {
    text-align: center;
    margin-top: 2rem;
  }
</style>
