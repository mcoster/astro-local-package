---
import ServiceCard from './ServiceCard.astro';
import { getCollection } from 'astro:content';

export interface Props {
  heading?: string;
  subtitle?: string;
  display?: 'all' | 'featured' | 'specific';
  specific?: string[];
  limit?: number;
  columns?: number;
  showIcons?: boolean;
  showViewAll?: boolean;
  layout?: 'auto' | 'fixed' | 'balanced';
  minCardWidth?: number;
  maxCardWidth?: number;
  justifyContent?: 'center' | 'space-between' | 'space-around' | 'flex-start';
}

const { 
  heading = 'Our Services',
  subtitle = 'Professional solutions tailored to your needs',
  display = 'featured',
  specific = [],
  limit,
  columns = 3,
  showIcons = true,
  showViewAll = false,
  layout = 'auto',
  minCardWidth = 280,
  maxCardWidth = 400,
  justifyContent = 'center'
} = Astro.props;

// Get all services from content collection
const allServices = await getCollection('services');

// Filter services based on display mode
let filteredServices = allServices;

if (display === 'featured') {
  filteredServices = allServices.filter(service => service.data.featured);
} else if (display === 'specific' && specific.length > 0) {
  filteredServices = allServices.filter(service => 
    specific.includes(service.slug)
  );
}

// Sort and limit services
const services = filteredServices
  .sort((a, b) => a.data.order - b.data.order)
  .slice(0, limit || filteredServices.length)
  .map(service => ({
    title: service.data.title,
    description: service.data.excerpt,
    icon: service.data.icon,
    image: service.data.image,
    href: `/services/${service.slug}`,
  }));

// Determine optimal columns based on service count for auto layout
const serviceCount = services.length;
let desktopCols: number; // columns for the main (or only) grid
let splitAt = 0; // index to split services into two grids (0 = no split)

if (layout === 'auto') {
  if (serviceCount <= 3) {
    desktopCols = serviceCount || 1; // 1, 2, or 3 cols — one row
  } else if (serviceCount === 4) {
    desktopCols = 2; // 2+2
  } else if (serviceCount % 3 === 1 && serviceCount >= 7) {
    // e.g. 7→3+2+2, 10→3+3+2+2, 13→3+3+3+2+2
    desktopCols = 3;
    splitAt = serviceCount - 4; // first group in 3-col, last 4 in 2-col
  } else {
    desktopCols = 3; // 5→3+2, 6→3+3, 8→3+3+2, 9→3+3+3, etc.
  }
} else {
  // layout === 'fixed' or 'balanced' — use explicit columns prop
  desktopCols = columns;
}
---

<section class="services-section">
  <div class="container">
    <div class="services-header">
      <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">{heading}</h2>
      {subtitle && <p class="services-subtitle">{subtitle}</p>}
    </div>
    <div class="services-grid-wrapper">
      {splitAt > 0 ? (
        <>
          <div
            class="services-grid services-grid--desktop-3"
            style={`justify-content: center; --max-card-width: ${maxCardWidth}px;`}
          >
            {services.slice(0, splitAt).map((service) => (
              <ServiceCard
                title={service.title}
                description={service.description}
                icon={service.icon}
                image={service.image}
                href={service.href}
              />
            ))}
          </div>
          <div
            class="services-grid services-grid--desktop-2"
            style={`justify-content: center; --max-card-width: ${maxCardWidth}px;`}
          >
            {services.slice(splitAt).map((service) => (
              <ServiceCard
                title={service.title}
                description={service.description}
                icon={service.icon}
                image={service.image}
                href={service.href}
              />
            ))}
          </div>
        </>
      ) : (
        <div
          class={`services-grid services-grid--desktop-${desktopCols}`}
          style={`justify-content: ${justifyContent}; --max-card-width: ${maxCardWidth}px;`}
        >
          {services.map((service) => (
            <ServiceCard
              title={service.title}
              description={service.description}
              icon={service.icon}
              image={service.image}
              href={service.href}
            />
          ))}
        </div>
      )}
    </div>
    {showViewAll && (
      <div class="services-footer">
        <a href="/services" class="btn-view-all">
          View All Services
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="arrow-icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
          </svg>
        </a>
      </div>
    )}
  </div>
</section>

<style>
  .services-section {
    display: block; /* Explicitly set to block to ensure margin: auto works on children */
    padding-top: 4rem;
    padding-bottom: 4rem;
    background-color: rgb(249 250 251);
  }

  @media (min-width: 768px) {
    .services-section {
      padding-top: 6rem;
      padding-bottom: 6rem;
    }
  }

  .container {
    max-width: 80rem;
    margin-left: auto;
    margin-right: auto;
    padding-left: 1rem;
    padding-right: 1rem;
  }

  @media (min-width: 640px) {
    .container {
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .container {
      padding-left: 2rem;
      padding-right: 2rem;
    }
  }

  .services-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  @media (min-width: 768px) {
    .services-header {
      margin-bottom: 4rem;
    }
  }


  .services-subtitle {
    font-size: 1.125rem;
    line-height: 1.75rem;
    color: rgb(75 85 99);
    max-width: 42rem;
    margin-left: auto;
    margin-right: auto;
  }

  @media (min-width: 768px) {
    .services-subtitle {
      font-size: 1.25rem;
      line-height: 1.75rem;
    }
  }

  /* Wrapper ensures consistent gap between split grids */
  .services-grid-wrapper {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    align-items: center;
  }

  .services-grid {
    display: grid;
    gap: 1.5rem;
    justify-content: center;
    width: 100%;
  }

  /* Mobile: single column, full width */
  @media (max-width: 639px) {
    .services-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
  }

  /* Tablet: max 2 columns */
  @media (min-width: 640px) and (max-width: 1023px) {
    .services-grid {
      grid-template-columns: repeat(2, minmax(0, var(--max-card-width, 350px)));
    }
    .services-grid--desktop-1 {
      grid-template-columns: minmax(0, var(--max-card-width, 350px));
    }
  }

  /* Desktop: column count based on service count */
  @media (min-width: 1024px) {
    .services-grid--desktop-1 {
      grid-template-columns: var(--max-card-width, 350px);
    }
    .services-grid--desktop-2 {
      grid-template-columns: repeat(2, var(--max-card-width, 350px));
    }
    .services-grid--desktop-3 {
      grid-template-columns: repeat(3, var(--max-card-width, 350px));
    }
  }
  
  .services-footer {
    text-align: center;
    margin-top: 3rem;
  }
  
  .btn-view-all {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 1.75rem;
    background-color: var(--color-primary, #3b82f6);
    color: white;
    border-radius: 0.375rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 200ms ease;
  }
  
  .btn-view-all:hover {
    background-color: var(--color-primary-dark, #2563eb);
    gap: 0.75rem;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .arrow-icon {
    width: 1.25rem;
    height: 1.25rem;
  }
</style>